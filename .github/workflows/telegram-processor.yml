name: Telegram æ€è€ƒå¤„ç†å™¨

on:
  schedule:
    # æ¯ 10 åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    - cron: '*/10 * * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'è¦æ‰§è¡Œçš„æ“ä½œ'
        default: 'process'
        required: true
        type: choice
        options:
          - process
          - reminder
          - publish_digest
          - process_queues
          - list_queues

jobs:
  process-telegram:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install requests python-telegram-bot python-dateutil pyyaml

      - name: å‡†å¤‡ç›®å½•
        run: |
          mkdir -p data
          mkdir -p content/zh/posts
          mkdir -p content/zh/thoughts
          mkdir -p content/zh/daily
          mkdir -p content/posts
          mkdir -p content/thoughts
          mkdir -p content/daily

          # å¦‚æœä¸å­˜åœ¨åˆ™åˆå§‹åŒ– JSON æ–‡ä»¶
          [ -f data/queues.json ] || echo '{"threads":[],"telegram":[],"mastodon":[]}' > data/queues.json
          [ -f data/untagged_thoughts.json ] || echo '[]' > data/untagged_thoughts.json
          [ -f data/last_update_id.txt ] || echo '0' > data/last_update_id.txt
          [ -f data/config.json ] || echo '{"sns_channels":{"threads":{"enabled":true,"post_windows":["07:03","12:15","19:47"],"credentials":{}},"telegram":{"enabled":true,"post_windows":["08:00","13:00","20:00"],"credentials":{}},"mastodon":{"enabled":true,"post_windows":["09:00","15:00","21:00"],"credentials":{}}},"blog":{"daily_digest_time":"21:45","reminder_time":"21:45"}}' > data/config.json

      - name: è¿è¡Œç›¸åº”æ“ä½œ
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          AUTHORIZED_USER_ID: ${{ secrets.TELEGRAM_USER_ID }}
          ACTION: ${{ github.event.inputs.action || 'process' }}
          THREADS_USERNAME: ${{ secrets.THREADS_USERNAME }}
          THREADS_PASSWORD: ${{ secrets.THREADS_PASSWORD }}
          MASTODON_TOKEN: ${{ secrets.MASTODON_TOKEN }}
          MASTODON_INSTANCE: ${{ secrets.MASTODON_INSTANCE }}
        run: |
          python scripts/telegram_handler.py --action $ACTION

      - name: æäº¤æ›´æ”¹
        run: |
          git config --global user.name "Flow Bot"
          git config --global user.email "bot@example.com"

          git add data/ content/

          # åªæœ‰åœ¨æœ‰æ›´æ”¹æ—¶æ‰æäº¤
          if [ -n "$(git status --porcelain)" ]; then
            # æ ¹æ®å¤„ç†çš„å†…å®¹è‡ªå®šä¹‰æäº¤æ¶ˆæ¯
            if git status --porcelain | grep -q "content/zh/posts"; then
              BLOG_COUNT=$(git status --porcelain | grep "content/zh/posts" | wc -l)
              COMMIT_MSG="ğŸ“ æ·»åŠ äº† ${BLOG_COUNT} ç¯‡åšå®¢æ–‡ç« "
            elif git status --porcelain | grep -q "content/zh/thoughts"; then
              THOUGHT_COUNT=$(git status --porcelain | grep "content/zh/thoughts" | wc -l)
              COMMIT_MSG="ğŸ’­ æ·»åŠ äº† ${THOUGHT_COUNT} æ¡æƒ³æ³•"
            elif git status --porcelain | grep -q "content/zh/daily"; then
              COMMIT_MSG="ğŸ“… æ·»åŠ äº†æ—¥è®°"
            elif git status --porcelain | grep -q "data/"; then
              COMMIT_MSG="ğŸ”„ æ›´æ–°äº†æ•°æ®æ–‡ä»¶"
            else
              COMMIT_MSG="æ›´æ–°å†…å®¹"
            fi

            git commit -m "$COMMIT_MSG"
            git push
          else
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          fi
